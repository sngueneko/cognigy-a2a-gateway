<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Cognigy A2A Gateway ‚Äî End-to-End Dataflow + Output Normalization</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Syne:wght@500;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06090f;--s1:#0c1220;
  --border:#1c2d47;
  --blue:#4f9cf9;--cyan:#22d3ee;--green:#34d399;
  --orange:#fb923c;--purple:#a78bfa;--red:#f87171;--amber:#fbbf24;
  --lime:#a3e635;
  --txt:#c8d6ef;--muted:#4a6080;--dim:#7a96b8;
}
body{background:var(--bg);color:var(--txt);font-family:'IBM Plex Mono',monospace;padding:28px 20px 80px;overflow-x:auto}

.hdr{max-width:1200px;margin:0 auto 36px}
.hdr h1{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#fff;letter-spacing:-.5px}
.hdr p{font-size:10px;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:4px}

/* TAB NAV */
.tabs{max-width:1200px;margin:0 auto 28px;display:flex;gap:4px;flex-wrap:wrap}
.tab{font-size:9.5px;font-weight:700;padding:7px 16px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;letter-spacing:1px;text-transform:uppercase;transition:all .2s}
.tab:hover{border-color:#2a4060;color:var(--txt)}
.tab.active{background:#0f1f35;border-color:var(--blue);color:var(--blue)}
.tab.active-amber{background:#1a1000;border-color:var(--amber);color:var(--amber)}
.tab.active-cyan{background:#041520;border-color:var(--cyan);color:var(--cyan)}

.panel{display:none;max-width:1200px;margin:0 auto;animation:fadeIn .3s}
.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* ‚îÄ‚îÄ FLOW STEP CARDS ‚îÄ‚îÄ */
.flow{display:flex;flex-direction:column;gap:0}
.step{display:grid;grid-template-columns:64px 1fr;gap:0;opacity:0;transform:translateX(-10px);animation:slideIn .4s forwards}
@keyframes slideIn{to{opacity:1;transform:none}}
.step:nth-child(1){animation-delay:.04s}.step:nth-child(2){animation-delay:.10s}
.step:nth-child(3){animation-delay:.16s}.step:nth-child(4){animation-delay:.22s}
.step:nth-child(5){animation-delay:.28s}.step:nth-child(6){animation-delay:.34s}
.step:nth-child(7){animation-delay:.40s}.step:nth-child(8){animation-delay:.46s}
.step:nth-child(9){animation-delay:.52s}.step:nth-child(10){animation-delay:.58s}

.step-num-col{display:flex;flex-direction:column;align-items:center;padding-top:16px}
.step-num{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;font-family:'Syne',sans-serif;border:2px solid;flex-shrink:0}
.step-line{width:1px;flex:1;min-height:16px;margin-top:6px}
.step:last-child .step-line{display:none}

.step-body{padding:12px 0 12px 14px;border-bottom:1px solid #0d1a28}
.step:last-child .step-body{border-bottom:none}
.step-actor{font-size:9px;letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;font-weight:700}
.step-title{font-size:13px;font-weight:700;color:#fff;margin-bottom:8px;letter-spacing:-.2px}
.step-desc{font-size:10.5px;color:var(--dim);line-height:1.65;margin-bottom:8px}
.step-desc:last-child{margin-bottom:0}

code{font-size:9.5px;color:var(--cyan);background:#071520;padding:1px 5px;border-radius:3px}

.code-block{background:#07111e;border:1px solid #1a2d47;border-radius:8px;padding:12px 14px;font-size:9.5px;line-height:1.7;margin-top:8px;overflow-x:auto}
.code-block .k{color:#a78bfa}.code-block .s{color:#34d399}.code-block .v{color:#fb923c}.code-block .c{color:#4a6080}.code-block .e{color:#22d3ee}

/* step color themes */
.sn-blue{border-color:var(--blue);background:#0d1f38;color:var(--blue)}
.sl-blue{background:linear-gradient(to bottom,var(--blue),transparent)}
.sa-blue{color:var(--blue)}

.sn-purple{border-color:var(--purple);background:#180d30;color:var(--purple)}
.sl-purple{background:linear-gradient(to bottom,var(--purple),transparent)}
.sa-purple{color:var(--purple)}

.sn-orange{border-color:var(--orange);background:#1f1000;color:var(--orange)}
.sl-orange{background:linear-gradient(to bottom,var(--orange),transparent)}
.sa-orange{color:var(--orange)}

.sn-amber{border-color:var(--amber);background:#1a1200;color:var(--amber)}
.sl-amber{background:linear-gradient(to bottom,var(--amber),transparent)}
.sa-amber{color:var(--amber)}

.sn-green{border-color:var(--green);background:#071a10;color:var(--green)}
.sl-green{background:linear-gradient(to bottom,var(--green),transparent)}
.sa-green{color:var(--green)}

.sn-cyan{border-color:var(--cyan);background:#041520;color:var(--cyan)}
.sl-cyan{background:linear-gradient(to bottom,var(--cyan),transparent)}
.sa-cyan{color:var(--cyan)}

.sn-red{border-color:var(--red);background:#1a0707;color:var(--red)}
.sl-red{background:linear-gradient(to bottom,var(--red),transparent)}
.sa-red{color:var(--red)}

.sn-lime{border-color:var(--lime);background:#0e1600;color:var(--lime)}
.sl-lime{background:linear-gradient(to bottom,var(--lime),transparent)}
.sa-lime{color:var(--lime)}

/* pills */
.pill{display:inline-block;font-size:8px;font-weight:700;padding:2px 7px;border-radius:100px;letter-spacing:.8px;text-transform:uppercase;margin:2px 3px 2px 0}
.p-in{background:#0d2035;color:var(--blue);border:1px solid #1a3d6a}
.p-out{background:#071a10;color:var(--green);border:1px solid #1a4a28}
.p-warn{background:#1a1000;color:var(--amber);border:1px solid #3d2800}
.p-code{background:#070e18;color:var(--cyan);border:1px solid #0d2035}
.p-pool{background:#1a1000;color:var(--amber);border:1px solid #3d2a00}
.p-err{background:#1a0505;color:var(--red);border:1px solid #3d1010}
.p-art{background:#1a0800;color:var(--orange);border:1px solid #3d2000}
.p-status{background:#071a10;color:var(--green);border:1px solid #1a4a28}

/* ‚îÄ‚îÄ NORMALIZER PANEL styles ‚îÄ‚îÄ */
.norm-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.norm-card{background:#0c1015;border:1px solid var(--border);border-radius:12px;padding:18px}
.norm-card-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.norm-card-body{font-size:10px;color:var(--dim);line-height:1.7}

.kind-tag{display:inline-block;font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;letter-spacing:1px;margin-bottom:8px}
.kind-status{background:#071a10;color:var(--green);border:1px solid #1a4a28}
.kind-artifact{background:#1a0800;color:var(--orange);border:1px solid #3d2000}

.norm-table{width:100%;border-collapse:collapse;font-size:9.5px;margin-top:10px}
.norm-table th{color:var(--muted);font-size:8.5px;letter-spacing:1.5px;text-transform:uppercase;padding:6px 8px;border-bottom:1px solid var(--border);text-align:left;font-weight:700}
.norm-table td{padding:7px 8px;border-bottom:1px solid #0d1520;color:var(--dim);vertical-align:top;line-height:1.5}
.norm-table td:first-child{color:var(--orange);font-weight:600}
.norm-table td .t{color:var(--green)}.norm-table td .d{color:var(--blue)}.norm-table td .f{color:var(--orange)}
.norm-table tr:last-child td{border-bottom:none}

.mime-table{width:100%;border-collapse:collapse;font-size:9.5px;margin-top:8px}
.mime-table td{padding:4px 8px;color:var(--dim);vertical-align:top}
.mime-table td:first-child{color:var(--amber);font-weight:600;width:60px}
.mime-table td:nth-child(2){color:var(--cyan);width:140px}

/* card extraction tree */
.card-tree{display:flex;flex-direction:column;gap:3px;margin-top:8px;font-size:9.5px}
.ct-row{display:flex;align-items:flex-start;gap:8px;padding:4px 8px;border-radius:4px;background:#070e18;border:1px solid #0d1a28}
.ct-type{color:var(--purple);font-weight:700;min-width:130px;flex-shrink:0}
.ct-desc{color:var(--dim);line-height:1.5}

/* ‚îÄ‚îÄ SOCKET MANAGEMENT PANEL ‚îÄ‚îÄ */
.sm-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.sm-card{background:#0c1015;border:1px solid var(--border);border-radius:12px;padding:18px}
.sm-card-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.sm-card-body{font-size:10px;color:var(--dim);line-height:1.7}

.state-machine{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.sm-state{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;border:1px solid}
.sm-state-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.sm-state-name{font-weight:700;font-size:10px;min-width:100px;flex-shrink:0}
.sm-state-desc{font-size:9.5px;color:var(--dim)}
.sm-arrow{font-size:9px;color:var(--muted);padding:2px 0 2px 32px;display:flex;align-items:center;gap:6px}

.st-connecting{background:#070d1a;border-color:#1a3060;color:var(--blue)}
.st-connecting .sm-state-dot{background:var(--blue)}
.st-idle{background:#060f09;border-color:#1a3d20;color:var(--green)}
.st-idle .sm-state-dot{background:var(--green);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.st-active{background:#120e00;border-color:#3d2800;color:var(--amber)}
.st-active .sm-state-dot{background:var(--amber)}
.st-reconn{background:#120700;border-color:#3a1a00;color:#ff7043}
.st-reconn .sm-state-dot{background:#ff7043}
.st-dead{background:#110404;border-color:#3d1010;color:var(--red)}
.st-dead .sm-state-dot{background:var(--red)}

.pool-diagram{margin-top:10px}
.pd-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:9.5px}
.pd-label{color:var(--muted);min-width:100px;flex-shrink:0}
.pd-conn{height:24px;border-radius:4px;padding:0 10px;display:flex;align-items:center;font-size:9px;font-weight:700;letter-spacing:.5px;flex:1}
.pd-sess{height:18px;border-radius:3px;padding:0 8px;display:flex;align-items:center;font-size:8.5px;margin-left:6px}
.pd-active{background:#0a1f10;border:1px solid var(--green);color:var(--green)}
.pd-idle{background:#0a0f18;border:1px solid var(--muted);color:var(--muted)}
.pd-sess-a{background:#081510;border:1px solid #1a3d20;color:#94e8d0}
.pd-sess-i{background:#080808;border:1px solid #222;color:#444}

.backoff-diagram{display:flex;align-items:flex-end;gap:6px;margin-top:12px;padding:12px;background:#080e18;border-radius:8px;border:1px solid var(--border)}
.bd-bar-group{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1}
.bd-bar{border-radius:3px 3px 0 0;width:100%}
.bd-time{font-size:8px;color:var(--amber);text-align:center}
.bd-att{font-size:8px;color:var(--muted);text-align:center}

.timeline{display:flex;flex-direction:column;gap:0}
.tl-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid #0d1520;font-size:10px}
.tl-item:last-child{border-bottom:none}
.tl-time{width:70px;flex-shrink:0;color:var(--amber);font-size:9px;font-weight:700;padding-top:1px}
.tl-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:4px}
.tl-body{flex:1}
.tl-event{color:#fff;font-weight:600;font-size:10px;margin-bottom:2px}
.tl-detail{color:var(--dim);font-size:9.5px;line-height:1.5}

.new-badge{display:inline-block;font-size:7px;font-weight:700;padding:2px 6px;border-radius:3px;background:#3d2a00;color:var(--amber);letter-spacing:1.5px;text-transform:uppercase;vertical-align:middle;margin-left:6px}
.upd-badge{display:inline-block;font-size:7px;font-weight:700;padding:2px 6px;border-radius:3px;background:#0a2a3d;color:var(--cyan);letter-spacing:1.5px;text-transform:uppercase;vertical-align:middle;margin-left:6px}

/* ‚îÄ‚îÄ LIGHT MODE ‚îÄ‚îÄ */
html.light {
  --bg:#f0f4f8;--s1:#e8edf4;--border:#cbd5e1;
  --blue:#1d4ed8;--cyan:#0e7490;--green:#047857;
  --orange:#c2410c;--purple:#6d28d9;--red:#b91c1c;--amber:#92400e;--lime:#4d7c0f;
  --txt:#1e293b;--muted:#64748b;--dim:#475569;
}
html.light body { background:var(--bg); color:var(--txt); }
html.light .hdr h1 { color:#0f172a; }
html.light .tab { background:#fff; border-color:#e2e8f0; color:#64748b; }
html.light .tab:hover { border-color:#94a3b8; color:#334155; }
html.light .tab.active { background:#eff6ff; border-color:#1d4ed8; color:#1d4ed8; }
html.light .tab.active-amber { background:#fffbeb; border-color:#d97706; color:#92400e; }
html.light .tab.active-cyan { background:#ecfeff; border-color:#0e7490; color:#0e7490; }
html.light .step-body { border-color:#e2e8f0; }
html.light .step-title { color:#0f172a; }
html.light .step-desc { color:#475569; }
html.light code { color:#0e7490; background:#ecfeff; }
html.light .code-block { background:#f8fafc; border-color:#e2e8f0; color:#1e293b; }
html.light .code-block .k { color:#6d28d9; }
html.light .code-block .s { color:#15803d; }
html.light .code-block .v { color:#c2410c; }
html.light .code-block .c { color:#94a3b8; }
html.light .code-block .e { color:#0e7490; }
html.light .sn-blue   { border-color:#3b82f6; background:#eff6ff; color:#1d4ed8; }
html.light .sn-purple { border-color:#8b5cf6; background:#faf5ff; color:#6d28d9; }
html.light .sn-orange { border-color:#f97316; background:#fff7ed; color:#c2410c; }
html.light .sn-amber  { border-color:#f59e0b; background:#fffbeb; color:#92400e; }
html.light .sn-green  { border-color:#22c55e; background:#f0fdf4; color:#15803d; }
html.light .sn-cyan   { border-color:#06b6d4; background:#ecfeff; color:#0e7490; }
html.light .sn-red    { border-color:#ef4444; background:#fff5f5; color:#b91c1c; }
html.light .sn-lime   { border-color:#84cc16; background:#f7fee7; color:#4d7c0f; }
html.light .p-in   { background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe; }
html.light .p-out  { background:#f0fdf4; color:#15803d; border-color:#86efac; }
html.light .p-warn { background:#fffbeb; color:#92400e; border-color:#fde68a; }
html.light .p-code { background:#ecfeff; color:#0e7490; border-color:#a5f3fc; }
html.light .p-pool { background:#fffbeb; color:#92400e; border-color:#fde68a; }
html.light .p-err  { background:#fff5f5; color:#b91c1c; border-color:#fecaca; }
html.light .p-art  { background:#fff7ed; color:#c2410c; border-color:#fed7aa; }
html.light .p-status { background:#f0fdf4; color:#15803d; border-color:#86efac; }
html.light .norm-card { background:#fff; border-color:#e2e8f0; }
html.light .norm-card-body { color:#475569; }
html.light .kind-status { background:#f0fdf4; color:#15803d; border-color:#86efac; }
html.light .kind-artifact { background:#fff7ed; color:#c2410c; border-color:#fed7aa; }
html.light .norm-table th { color:#64748b; border-color:#e2e8f0; }
html.light .norm-table td { border-color:#e2e8f0; color:#475569; }
html.light .norm-table td .t { color:#047857; }
html.light .norm-table td .d { color:#1d4ed8; }
html.light .norm-table td .f { color:#c2410c; }
html.light .mime-table td { color:#475569; }
html.light .mime-table td:first-child { color:#92400e; }
html.light .mime-table td:nth-child(2) { color:#0e7490; }
html.light .ct-row { background:#f8fafc; border-color:#e2e8f0; }
html.light .ct-type { color:#6d28d9; }
html.light .ct-desc { color:#475569; }
html.light .sm-card { background:#fff; border-color:#e2e8f0; }
html.light .sm-card-body { color:#475569; }
html.light .sm-state-desc { color:#475569; }
html.light .sm-arrow { color:#94a3b8; }
html.light .st-connecting { background:#eff6ff; border-color:#93c5fd; color:#1d4ed8; }
html.light .st-idle       { background:#f0fdf4; border-color:#86efac; color:#15803d; }
html.light .st-active     { background:#fffbeb; border-color:#fde68a; color:#92400e; }
html.light .st-reconn     { background:#fff5f0; border-color:#fdba74; color:#c2410c; }
html.light .st-dead       { background:#fff5f5; border-color:#fca5a5; color:#b91c1c; }
html.light .pool-diagram .pd-conn.pd-active { background:#f0fdf4; border-color:#86efac; color:#15803d; }
html.light .pool-diagram .pd-conn.pd-idle   { background:#f8fafc; border-color:#e2e8f0; color:#94a3b8; }
html.light .pool-diagram .pd-sess.pd-sess-a { background:#ecfeff; border-color:#a5f3fc; color:#0e7490; }
html.light .pool-diagram .pd-sess.pd-sess-i { background:#f8fafc; border-color:#e2e8f0; color:#cbd5e1; }
html.light .backoff-diagram { background:#f8fafc; border-color:#e2e8f0; }
html.light .timeline .tl-item { border-color:#e2e8f0; }
html.light .tl-time  { color:#92400e; }
html.light .tl-event { color:#0f172a; }
html.light .tl-detail{ color:#475569; }
html.light .new-badge { background:#fef3c7; color:#92400e; }
html.light .upd-badge { background:#cffafe; color:#0e7490; }

/* toggle */
#theme-toggle {
  position:fixed;top:18px;right:22px;z-index:1000;
  background:var(--s1);border:1px solid var(--border);
  border-radius:100px;padding:6px 14px 6px 10px;
  display:flex;align-items:center;gap:7px;cursor:pointer;
  font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:700;
  color:var(--txt);letter-spacing:.5px;transition:all .25s;box-shadow:0 2px 12px rgba(0,0,0,.2);
}
#theme-toggle:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(0,0,0,.3); }
#theme-toggle .ico { font-size:14px; line-height:1; }
html.light #theme-toggle { background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.1); }
</style>
</head>
<body>

<button id="theme-toggle" onclick="toggleTheme()">
  <span class="ico" id="toggle-ico">‚òÄÔ∏è</span>
  <span id="toggle-lbl">Light Mode</span>
</button>
<script>
(function(){
  const saved = localStorage.getItem('theme') || 'dark';
  if(saved === 'light') { document.documentElement.classList.add('light'); updateBtn('light'); }
  function updateBtn(t){
    const ico = document.getElementById('toggle-ico');
    const lbl = document.getElementById('toggle-lbl');
    if(!ico||!lbl) return;
    ico.textContent = t==='light' ? 'üåô' : '‚òÄÔ∏è';
    lbl.textContent = t==='light' ? 'Dark Mode' : 'Light Mode';
  }
  window.toggleTheme = function(){
    const isLight = document.documentElement.classList.toggle('light');
    const t = isLight ? 'light' : 'dark';
    localStorage.setItem('theme', t);
    updateBtn(t);
  };
})();
</script>

<div class="hdr">
  <h1>Cognigy A2A Gateway ‚Äî End-to-End Dataflow</h1>
  <p>REST Flow ¬∑ Socket Flow ¬∑ Output Normalization ¬∑ Socket Connection Management</p>
</div>

<div class="tabs">
  <button class="tab active" onclick="showPanel('flow-rest', this)">REST Flow</button>
  <button class="tab" onclick="showPanel('flow-socket', this)">Socket Flow (Agentic)</button>
  <button class="tab" onclick="showPanel('normalization', this)" style="border-color:#0e3d4a;color:var(--cyan)">‚ö° Output Normalization</button>
  <button class="tab active-amber" onclick="showPanel('socket-mgmt', this)" style="border-color:#3d2800;color:var(--amber)">üîå Socket Connection Management</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REST FLOW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel active" id="flow-rest">
<div class="flow">

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-blue">1</div><div class="step-line sl-blue"></div></div>
    <div class="step-body">
      <div class="step-actor sa-blue">A2A Client ‚Üí Gateway</div>
      <div class="step-title">A2A Request ‚Äî POST /agents/billing-agent/a2a</div>
      <div class="step-desc">Der Consumer sendet einen JSON-RPC Request. contextId identifiziert die Konversation, das Gateway erkennt aus der Registry: endpointType = "REST".</div>
      <div class="code-block">
<span class="k">POST</span> /agents/billing-agent/a2a<br>
{ <span class="e">contextId</span>: <span class="s">"ctx-invoice-42"</span>, <span class="e">message</span>: { <span class="e">parts</span>: [{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Zeig mir Rechnung #8821"</span> }] } }
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-purple">2</div><div class="step-line sl-purple"></div></div>
    <div class="step-body">
      <div class="step-actor sa-purple">Gateway ‚Äî Registry Lookup</div>
      <div class="step-title">Agent Registry ‚Üí REST Adapter gew√§hlt</div>
      <div class="step-desc">Session Store: <code>cognigy.sessionId = "ctx-invoice-42"</code>. Adapter: <code>RestAdapter</code>. Kein Connection Management n√∂tig.</div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-orange">3</div><div class="step-line sl-orange"></div></div>
    <div class="step-body">
      <div class="step-actor sa-orange">Gateway ‚Üí Cognigy REST</div>
      <div class="step-title">HTTP POST ‚Üí Cognigy Standalone Flow</div>
      <div class="step-desc">axios sendet synchronen Request. Timeout: 8 Sekunden. Cognigy gibt alle Outputs in <code>outputStack[]</code> zur√ºck.</div>
      <div class="code-block">
<span class="c">‚Üê Response: { outputStack: [{ text: "Rechnung #8821 vom 15.01.2025: 1.240,00 ‚Ç¨", data: {} }] }</span>
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-cyan">4</div><div class="step-line sl-cyan"></div></div>
    <div class="step-body">
      <div class="step-actor sa-cyan">Gateway ‚Äî OutputNormalizer</div>
      <div class="step-title">normalizeOutputs(stack) ‚Üí Part[] f√ºr Message</div>
      <div class="step-desc">REST-Pfad: <code>normalizeOutputs()</code> ruft <code>normalizeOutput()</code> f√ºr jeden Output und flacht alle <code>NormalizedOutput.parts</code> in ein einziges <code>Part[]</code> ab. Media-Outputs (Image/Audio/Video) landen inline als FilePart, da kein Streaming m√∂glich ist.</div>
      <div class="code-block">
<span class="c">// normalizeOutput ‚Üí StatusMessageOutput { kind:'status-message', parts:[TextPart] }</span><br>
<span class="c">// normalizeOutputs ‚Üí flatten all .parts ‚Üí Part[]</span><br>
[{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Rechnung #8821 vom 15.01.2025: 1.240,00 ‚Ç¨"</span> }]
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-green">5</div><div class="step-line sl-green"></div></div>
    <div class="step-body">
      <div class="step-actor sa-green">Gateway ‚Üí A2A Client</div>
      <div class="step-title">A2A Message Response ‚Äî einmaliger vollst√§ndiger Block</div>
      <div class="step-desc">Ein einziger SSE-Block. Kein Task-Lifecycle, keine Artifacts. Gesamtlatenz: Cognigy Flow-Zeit + Normalizer (typisch 1‚Äì4s).</div>
      <div class="code-block">
<span class="e">data</span>: { <span class="e">kind</span>: <span class="s">"message"</span>, <span class="e">parts</span>: [{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Rechnung #8821..."</span> }] }
      </div>
    </div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOCKET FLOW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="flow-socket">
<div class="flow">

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-blue">1</div><div class="step-line sl-blue"></div></div>
    <div class="step-body">
      <div class="step-actor sa-blue">A2A Client ‚Üí Gateway</div>
      <div class="step-title">A2A Request ‚Äî POST /agents/booking-agent/a2a</div>
      <div class="step-desc">Gateway erkennt: endpointType = "SOCKET" ‚Üí Socket Adapter + Connection Pool werden aktiviert.</div>
      <div class="code-block">
{ <span class="e">contextId</span>: <span class="s">"ctx-abc123"</span>, <span class="e">message</span>: { <span class="e">parts</span>: [{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Buche Flug nach Berlin am 15.03"</span> }] } }
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-amber">2</div><div class="step-line sl-amber"></div></div>
    <div class="step-body">
      <div class="step-actor sa-amber">CognigyAgentExecutor</div>
      <div class="step-title">Task ge√∂ffnet ‚Üí TaskStatusUpdateEvent { state:'working' }</div>
      <div class="step-desc">Bevor der Adapter aufgerufen wird, sendet der Executor sofort das erste Event: Task ist gestartet. Der Client kann nun auf Streaming-Events warten.</div>
      <div class="code-block">
<span class="e">data</span>: { <span class="e">kind</span>: <span class="s">"status-update"</span>, <span class="e">status</span>: { <span class="e">state</span>: <span class="s">"working"</span> }, <span class="e">final</span>: <span class="k">false</span> }
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-amber">3</div><div class="step-line sl-amber"></div></div>
    <div class="step-body">
      <div class="step-actor sa-amber">Connection Pool + Socket Adapter</div>
      <div class="step-title">Pool Lookup ‚Üí bestehende WS wiederverwenden oder neue aufbauen</div>
      <div class="step-desc">SocketAdapter unwrapped automatisch den <code>_cognigy._default</code> Envelope. Media-Felder (<code>_image</code>, <code>_audio</code>, <code>_video</code>) werden als separate Outputs erkannt.</div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-purple">4</div><div class="step-line sl-purple"></div></div>
    <div class="step-body">
      <div class="step-actor sa-purple">Cognigy Agentic Flow</div>
      <div class="step-title">LLM Reasoning ‚Üí mehrere emit("output")</div>
      <div class="step-desc">Der Agentic Flow emittiert mehrfach: erst plain text, dann ein QuickReplies-Output. Jedes <code>on("output")</code> triggert sofort <code>onOutput(output, i)</code> ‚Üí <code>normalizeOutput()</code> ‚Üí Event-Routing.</div>
      <div class="code-block">
emit(<span class="s">"output"</span>) ‚Üí { <span class="e">text</span>: <span class="s">"Ich suche verf√ºgbare Fl√ºge..."</span> }<br>
emit(<span class="s">"output"</span>) ‚Üí { <span class="e">text</span>: <span class="k">null</span>, <span class="e">data</span>: { <span class="e">_cognigy</span>: { <span class="e">_default</span>: { <span class="e">_quickReplies</span>: { <span class="e">text</span>: <span class="s">"Bitte w√§hlen"</span>, <span class="e">quickReplies</span>: [...] } } } } }<br>
emit(<span class="s">"finalPing"</span>) ‚Üí Flow abgeschlossen
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-cyan">5</div><div class="step-line sl-cyan"></div></div>
    <div class="step-body">
      <div class="step-actor sa-cyan">OutputNormalizer ‚Üí Event-Router</div>
      <div class="step-title">normalizeOutput() ‚Üí NormalizedOutput.kind ‚Üí korrektes A2A Event</div>
      <div class="step-desc">Output #1 ‚Üí <code>StatusMessageOutput</code> ‚Üí <code>TaskStatusUpdateEvent</code> mit message. Output #2 ‚Üí <code>StatusMessageOutput</code> (Quick Replies) ‚Üí <code>TaskStatusUpdateEvent</code> mit message {TextPart + DataPart}.</div>
      <div class="code-block">
<span class="c">// Output #1 ‚Üí kind:'status-message'</span><br>
‚Üí TaskStatusUpdateEvent { <span class="e">state</span>: <span class="s">'working'</span>, <span class="e">message</span>: { <span class="e">parts</span>: [{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Ich suche..."</span> }] } }<br><br>
<span class="c">// Output #2 ‚Üí kind:'status-message' (QuickReplies)</span><br>
‚Üí TaskStatusUpdateEvent { <span class="e">state</span>: <span class="s">'working'</span>, <span class="e">message</span>: { <span class="e">parts</span>: [<br>
&nbsp;&nbsp;{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Bitte w√§hlen\n- LH123 ¬∑ 09:00 ¬∑ 320‚Ç¨\n- LH456 ¬∑ 14:30 ¬∑ 280‚Ç¨"</span> },<br>
&nbsp;&nbsp;{ <span class="e">kind</span>: <span class="s">"data"</span>, <span class="e">data</span>: { <span class="e">type</span>: <span class="s">"quick_replies"</span>, <span class="e">payload</span>: { <span class="e">quickReplies</span>: [...] } } }<br>
]}}<br><br>
<span class="c">// Wenn stattdessen ein Image-Output k√§me ‚Üí kind:'artifact'</span><br>
‚Üí TaskArtifactUpdateEvent { <span class="e">artifact</span>: { <span class="e">name</span>: <span class="s">"photo.jpg"</span>, <span class="e">parts</span>: [<br>
&nbsp;&nbsp;{ <span class="e">kind</span>: <span class="s">"file"</span>, <span class="e">file</span>: { <span class="e">uri</span>: <span class="s">"https://..."</span>, <span class="e">mimeType</span>: <span class="s">"image/jpeg"</span> } },<br>
&nbsp;&nbsp;{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"[Image: https://...]"</span> }<br>
]}}
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-green">6</div><div class="step-line sl-green"></div></div>
    <div class="step-body">
      <div class="step-actor sa-green">Gateway ‚Üí A2A Client (SSE Stream)</div>
      <div class="step-title">Live-Streaming: TaskStatusUpdateEvents ‚Üí completed</div>
      <div class="step-desc">Der vollst√§ndige SSE-Stream. Jeder Cognigy-Output erscheint sofort beim Client. Nach dem finalPing: <code>completed</code>-Event schlie√üt den Stream.</div>
      <div class="code-block">
<span class="c">// #1 Task ge√∂ffnet (kein message)</span><br>
<span class="e">data</span>: { <span class="e">kind</span>: <span class="s">"status-update"</span>, <span class="e">status</span>: { <span class="e">state</span>: <span class="s">"working"</span> }, <span class="e">final</span>: <span class="k">false</span> }<br><br>
<span class="c">// #2 Erstes Cognigy-Output (plain text)</span><br>
<span class="e">data</span>: { <span class="e">kind</span>: <span class="s">"status-update"</span>, <span class="e">status</span>: { <span class="e">state</span>: <span class="s">"working"</span>, <span class="e">message</span>: { <span class="e">parts</span>: [{ <span class="e">kind</span>: <span class="s">"text"</span>, <span class="e">text</span>: <span class="s">"Ich suche..."</span> }] } }, <span class="e">final</span>: <span class="k">false</span> }<br><br>
<span class="c">// #3 Zweites Cognigy-Output (QuickReplies)</span><br>
<span class="e">data</span>: { <span class="e">kind</span>: <span class="s">"status-update"</span>, <span class="e">status</span>: { <span class="e">state</span>: <span class="s">"working"</span>, <span class="e">message</span>: { <span class="e">parts</span>: [TextPart, DataPart] } }, <span class="e">final</span>: <span class="k">false</span> }<br><br>
<span class="c">// #4 finalPing ‚Üí Task abgeschlossen</span><br>
<span class="e">data</span>: { <span class="e">kind</span>: <span class="s">"status-update"</span>, <span class="e">status</span>: { <span class="e">state</span>: <span class="s">"completed"</span> }, <span class="e">final</span>: <span class="k">true</span> }
      </div>
      <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px">
        <span class="pill p-status">conversational ‚Üí TaskStatusUpdateEvent</span>
        <span class="pill p-art">image/audio/video ‚Üí TaskArtifactUpdateEvent</span>
        <span class="pill p-out">immer: TextPart garantiert</span>
      </div>
    </div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NORMALIZATION PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="normalization">

  <div class="norm-grid">

    <!-- STATUS MESSAGE OUTPUT -->
    <div class="norm-card">
      <div class="norm-card-title" style="color:var(--green)">üí¨ StatusMessageOutput</div>
      <div class="kind-tag kind-status">kind: 'status-message'</div>
      <div class="norm-card-body" style="margin-bottom:10px">Alle konversationellen / UI Outputs. Landen in <code>TaskStatusUpdateEvent.status.message.parts[]</code>. Immer mit TextPart ‚Äî LLM-Agents k√∂nnen jeden Typ lesen.</div>
      <table class="norm-table">
        <tr><th>Cognigy Type</th><th>TextPart Inhalt</th><th>DataPart type</th></tr>
        <tr>
          <td>plain text</td>
          <td><span class="t">output.text verbatim</span></td>
          <td style="color:var(--muted)">‚Äî</td>
        </tr>
        <tr>
          <td>_quickReplies</td>
          <td><span class="t">label + "- Titel A\n- Titel B ![image](url)"</span></td>
          <td><span class="d">quick_replies</span></td>
        </tr>
        <tr>
          <td>_buttons</td>
          <td><span class="t">label + "- Button 1" / "- Button 1: https://url" (web_url)</span></td>
          <td><span class="d">buttons</span></td>
        </tr>
        <tr>
          <td>_list</td>
          <td><span class="t">header + "- Titel: Subtitle ![image](url)"</span></td>
          <td><span class="d">list</span></td>
        </tr>
        <tr>
          <td>_gallery</td>
          <td><span class="t">output.text oder "Here are some options:" + "- Titel: Subtitle ![image](url)"</span></td>
          <td><span class="d">carousel</span></td>
        </tr>
        <tr>
          <td>_adaptiveCard</td>
          <td><span class="t">TextBlocks + FactSet + Inputs + Actions (rekursiv)</span></td>
          <td><span class="d">AdaptiveCard</span></td>
        </tr>
        <tr>
          <td>custom data</td>
          <td><span class="t">_fallbackText (wenn vorhanden)</span></td>
          <td><span class="d">cognigy/data</span></td>
        </tr>
      </table>
      <div style="margin-top:10px;font-size:9px;color:var(--muted)">DataPart.data = { type: "quick_replies", payload: { ...original Cognigy payload verbatim... } }<br>_cognigy und _fallbackText werden vor dem DataPart gestripped.</div>
    </div>

    <!-- ARTIFACT OUTPUT -->
    <div class="norm-card">
      <div class="norm-card-title" style="color:var(--orange)">üìÅ ArtifactOutput</div>
      <div class="kind-tag kind-artifact">kind: 'artifact'</div>
      <div class="norm-card-body" style="margin-bottom:10px">Binary Media Outputs. Landen in <code>TaskArtifactUpdateEvent.artifact</code>. FilePart enth√§lt URI + MIME-Typ. TextPart ist Fallback f√ºr LLM-Agents.</div>
      <table class="norm-table">
        <tr><th>Cognigy Type</th><th>FilePart</th><th>TextPart</th></tr>
        <tr>
          <td>_image</td>
          <td><span class="f">uri + mimeType: image/*</span></td>
          <td><span class="t">[Image: url]</span></td>
        </tr>
        <tr>
          <td>_audio</td>
          <td><span class="f">uri + mimeType: audio/*</span></td>
          <td><span class="t">[Audio: url]</span></td>
        </tr>
        <tr>
          <td>_video</td>
          <td><span class="f">uri + mimeType: video/*</span></td>
          <td><span class="t">[Video: url]</span></td>
        </tr>
      </table>

      <div style="margin-top:14px;font-size:9.5px;color:var(--dim);font-weight:700;margin-bottom:6px">MIME-Typ Inferenz ‚Äî aus URL-Extension:</div>
      <table class="mime-table">
        <tr><td>image</td><td>jpg jpeg png gif webp svg bmp ico</td><td style="color:var(--dim);font-size:9px">‚Üí image/jpeg, image/png ...</td></tr>
        <tr><td>audio</td><td>mp3 ogg wav m4a aac flac webm</td><td style="color:var(--dim);font-size:9px">‚Üí audio/mpeg, audio/ogg ...</td></tr>
        <tr><td>video</td><td>mp4 webm ogg avi mov mkv m4v</td><td style="color:var(--dim);font-size:9px">‚Üí video/mp4, video/webm ...</td></tr>
      </table>
      <div style="margin-top:8px;font-size:9px;color:var(--muted)">Query-String wird vor Extension-Erkennung gestripped. Unbekannte Extension ‚Üí Fallback (image/jpeg, audio/mpeg, video/mp4).</div>
    </div>

  </div>

  <!-- ADAPTIVE CARD EXTRACTION -->
  <div class="norm-card" style="margin-bottom:16px">
    <div class="norm-card-title" style="color:var(--purple)">üÉè Adaptive Card ‚Äî Vollst√§ndige Rekursive Extraktion</div>
    <div class="norm-card-body" style="margin-bottom:10px">
      Der Adaptive Card Renderer durchl√§uft <strong style="color:#fff">alle bekannten Element-Typen rekursiv</strong> (ColumnSet ‚Üí columns ‚Üí items, Container ‚Üí items). Das Resultat: ein einziger lesbarer Text-Block, den ein LLM-Agent ohne Kenntnis des AdaptiveCard-Schemas interpretieren kann ‚Äî inklusive angezeigter Inhalte (TextBlocks) UND aller User-Interaktionen (Inputs, Actions).
    </div>
    <div class="card-tree">
      <div class="ct-row"><span class="ct-type">TextBlock</span><span class="ct-desc">‚Üí .text Wert direkt √ºbernommen</span></div>
      <div class="ct-row"><span class="ct-type">FactSet</span><span class="ct-desc">‚Üí "Titel: Wert" pro fact (beide Felder vorhanden)</span></div>
      <div class="ct-row"><span class="ct-type">Input.Text / Date / Number / Time</span><span class="ct-desc">‚Üí label (placeholder) als kombinierter Hinweis</span></div>
      <div class="ct-row"><span class="ct-type">Input.ChoiceSet</span><span class="ct-desc">‚Üí label + "- choice.title" pro Auswahlm√∂glichkeit</span></div>
      <div class="ct-row"><span class="ct-type">Input.Toggle</span><span class="ct-desc">‚Üí .title Text</span></div>
      <div class="ct-row"><span class="ct-type">ColumnSet</span><span class="ct-desc">‚Üí rekursiert in columns[].items ‚Üí extractCardElement()</span></div>
      <div class="ct-row"><span class="ct-type">Container</span><span class="ct-desc">‚Üí rekursiert in .items ‚Üí extractCardElement()</span></div>
      <div class="ct-row"><span class="ct-type">Action.Submit / OpenUrl / ShowCard / Execute</span><span class="ct-desc">‚Üí "[Action: titel]" ‚Äî auch in card.actions[]</span></div>
      <div class="ct-row"><span class="ct-type">Image / Media / sonstige</span><span class="ct-desc">‚Üí √ºbersprungen (kein Text zu extrahieren)</span></div>
    </div>
    <div style="margin-top:10px;font-size:9px;color:var(--muted)">
      Unterst√ºtzt sowohl nested-Format <code>payload.adaptiveCard.body[]</code> als auch flat-Format <code>payload.body[]</code>.
      Adapter-Aktionen in <code>card.actions[]</code> werden separat nach dem body verarbeitet.
    </div>
  </div>

  <!-- EXECUTOR ROUTING LOGIC -->
  <div class="norm-card">
    <div class="norm-card-title" style="color:var(--cyan)">üîÄ CognigyAgentExecutor ‚Äî Event-Routing-Logik</div>
    <div class="norm-card-body" style="margin-bottom:10px">
      Der Executor konsumiert den <code>NormalizedOutput</code> Discriminated Union und routet per <code>.kind</code> Field. REST-Pfad und Socket-Pfad verhalten sich unterschiedlich.
    </div>
    <div class="code-block">
<span class="c">// SOCKET-Pfad: onOutput callback ‚Üí pro Cognigy-Output</span><br>
<span class="k">const</span> normalized = <span class="e">normalizeOutput</span>(output, index);<br><br>
<span class="k">if</span> (normalized.kind === <span class="s">'status-message'</span>) {<br>
&nbsp;&nbsp;<span class="c">// ‚Üí TaskStatusUpdateEvent { state:'working', message:{ parts }, final:false }</span><br>
&nbsp;&nbsp;eventBus.<span class="e">publish</span>({ <span class="e">kind</span>: <span class="s">'status-update'</span>, <span class="e">status</span>: { <span class="e">state</span>: <span class="s">'working'</span>, <span class="e">message</span>: { <span class="e">parts</span>: normalized.parts } } })<br>
}<br><br>
<span class="k">if</span> (normalized.kind === <span class="s">'artifact'</span>) {<br>
&nbsp;&nbsp;<span class="c">// ‚Üí TaskArtifactUpdateEvent { artifact:{ name, mimeType, parts } }</span><br>
&nbsp;&nbsp;eventBus.<span class="e">publish</span>({ <span class="e">kind</span>: <span class="s">'artifact-update'</span>, <span class="e">artifact</span>: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="e">name</span>: normalized.name, <span class="e">mimeType</span>: normalized.mimeType, <span class="e">parts</span>: normalized.parts<br>
&nbsp;&nbsp;}})<br>
}<br><br>
<span class="c">// REST-Pfad: normalizeOutputs() ‚Üí flatten ‚Üí Message.parts[]</span><br>
<span class="c">// Alle NormalizedOutput.parts werden inline in einen Part[] geflacht</span><br>
<span class="k">const</span> parts = <span class="e">normalizeOutputs</span>(outputs) <span class="c">// returns ReadonlyArray&lt;Part&gt;</span>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOCKET MANAGEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="socket-mgmt">

  <div class="sm-grid">

    <div class="sm-card">
      <div class="sm-card-title" style="color:var(--amber)">‚ö° Connection State Machine</div>
      <div class="sm-card-body">Eine Connection pro Agent-Endpoint durchl√§uft diese States:</div>
      <div class="state-machine">
        <div class="sm-state st-connecting">
          <div class="sm-state-dot"></div>
          <div class="sm-state-name">CONNECTING</div>
          <div class="sm-state-desc">client.connect() l√§uft ¬∑ Token-Auth ¬∑ Timeout 5s ¬∑ bei Fehler ‚Üí DEAD</div>
        </div>
        <div class="sm-arrow">‚Üì connect() erfolgreich</div>
        <div class="sm-state st-idle">
          <div class="sm-state-dot"></div>
          <div class="sm-state-name">IDLE</div>
          <div class="sm-state-desc">Verbunden ¬∑ Keepalive-Ping alle 30s ¬∑ nach 5min Inaktivit√§t ‚Üí Disconnect</div>
        </div>
        <div class="sm-arrow">‚Üì sendMessage() aufgerufen</div>
        <div class="sm-state st-active">
          <div class="sm-state-dot"></div>
          <div class="sm-state-name">ACTIVE</div>
          <div class="sm-state-desc">‚â•1 Session l√§uft ¬∑ Outputs flie√üen ¬∑ finalPing erwartet</div>
        </div>
        <div class="sm-arrow">‚Üì alle Sessions beendet ‚Üí IDLE | on("disconnect") ‚Üí RECONNECTING</div>
        <div class="sm-state st-reconn">
          <div class="sm-state-dot"></div>
          <div class="sm-state-name">RECONNECTING</div>
          <div class="sm-state-desc">Exponential Backoff: 1s ‚Üí 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s ‚Üí 30s ¬∑ Jitter ¬±20% ¬∑ max 6 Versuche</div>
        </div>
        <div class="sm-arrow">‚Üì max Versuche erreicht oder Auth-Fehler</div>
        <div class="sm-state st-dead">
          <div class="sm-state-dot"></div>
          <div class="sm-state-name">DEAD</div>
          <div class="sm-state-desc">Aus Pool entfernt ¬∑ alle Sessions erhalten Error ¬∑ n√§chster Request ‚Üí neue Connection</div>
        </div>
      </div>
    </div>

    <div class="sm-card">
      <div class="sm-card-title" style="color:var(--cyan)">‚Üî Session Multiplexing via Pool</div>
      <div class="sm-card-body" style="margin-bottom:10px">
        Viele parallele A2A-Requests nutzen <strong style="color:#fff">eine WS-Verbindung</strong> pro Agent-Endpoint. Isolation via <code>sessionId</code>.
      </div>
      <div class="pool-diagram">
        <div class="pd-row">
          <div class="pd-label" style="color:var(--amber);font-weight:700">booking-agent</div>
          <div class="pd-conn pd-active">‚óè WS ACTIVE ¬∑ endpoint-trial.cognigy.ai</div>
        </div>
        <div class="pd-row">
          <div class="pd-label" style="padding-left:12px">ctx-001</div>
          <div class="pd-sess pd-sess-a">‚Üî L√§uft ¬∑ LLM reasoning</div>
        </div>
        <div class="pd-row">
          <div class="pd-label" style="padding-left:12px">ctx-002</div>
          <div class="pd-sess pd-sess-a">‚Üî L√§uft ¬∑ Tool Call</div>
        </div>
        <div class="pd-row" style="margin-top:10px">
          <div class="pd-label" style="color:var(--muted);font-weight:700">billing-agent</div>
          <div class="pd-conn pd-idle">‚óã IDLE ¬∑ kein Traffic ¬∑ Keepalive</div>
        </div>
        <div class="pd-row" style="margin-top:10px">
          <div class="pd-label" style="color:var(--muted);font-weight:700">hr-agent</div>
          <div class="pd-conn" style="background:#080808;border:1px solid #1a1a1a;color:#333">‚Äî NICHT VERBUNDEN ¬∑ erster Request erstellt Connection</div>
        </div>
      </div>
      <div style="margin-top:12px;font-size:9.5px;color:var(--muted);line-height:1.6">
        <strong style="color:var(--cyan)">Output-Routing:</strong> on("output") pr√ºft <code>output.sessionId</code> ‚Üí dispatcht nur an den korrekten SSE-Stream.
      </div>
    </div>

  </div>

  <div class="sm-card" style="margin-bottom:16px">
    <div class="sm-card-title" style="color:#ff7043">üî¥ Reconnect-Szenario: Exponential Backoff</div>
    <div class="backoff-diagram">
      <div class="bd-bar-group"><div class="bd-bar" style="height:14px;background:linear-gradient(to top,#ef4444,#f87171)"></div><div class="bd-time">sofort</div><div class="bd-att">Att 1</div></div>
      <div class="bd-bar-group"><div class="bd-bar" style="height:20px;background:linear-gradient(to top,#f97316,#fb923c)"></div><div class="bd-time">+1s</div><div class="bd-att">Att 2</div></div>
      <div class="bd-bar-group"><div class="bd-bar" style="height:30px;background:linear-gradient(to top,#eab308,#fbbf24)"></div><div class="bd-time">+2s</div><div class="bd-att">Att 3</div></div>
      <div class="bd-bar-group"><div class="bd-bar" style="height:46px;background:linear-gradient(to top,#84cc16,#a3e635)"></div><div class="bd-time">+4s</div><div class="bd-att">Att 4</div></div>
      <div class="bd-bar-group"><div class="bd-bar" style="height:60px;background:linear-gradient(to top,#22d3ee,#67e8f9)"></div><div class="bd-time">+8s</div><div class="bd-att">Att 5</div></div>
      <div class="bd-bar-group"><div class="bd-bar" style="height:70px;background:linear-gradient(to top,#a78bfa,#c4b5fd)"></div><div class="bd-time">+16s</div><div class="bd-att">Att 6</div></div>
      <div style="padding-left:12px;display:flex;flex-direction:column;justify-content:flex-end;gap:4px;padding-bottom:2px">
        <div style="font-size:9px;color:var(--dim)">+ Jitter ¬±20%</div>
        <div style="font-size:9px;color:var(--dim)">Max Cap: 30s</div>
        <div style="font-size:9px;color:var(--red)">Auth ‚Üí kein Retry</div>
      </div>
    </div>
    <div class="timeline" style="margin-top:16px">
      <div class="tl-item">
        <div class="tl-time">T+0ms</div>
        <div class="tl-dot" style="background:var(--red)"></div>
        <div class="tl-body">
          <div class="tl-event">on("disconnect") gefeuert</div>
          <div class="tl-detail">Connection-State ‚Üí RECONNECTING ¬∑ SSE-Streams bleiben offen ¬∑ laufende Sessions merken sich ausstehende Nachrichten</div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-time">T+7000ms</div>
        <div class="tl-dot" style="background:var(--green)"></div>
        <div class="tl-body">
          <div class="tl-event">‚úì Reconnected ‚Äî Connection ACTIVE</div>
          <div class="tl-detail">Pool aktualisiert ¬∑ Session-Listener neu registriert ¬∑ Output-Flow geht weiter ¬∑ Client hat keinen Unterbruch gemerkt</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sm-card">
    <div class="sm-card-title" style="color:var(--green)">‚úì Kritische Regeln ‚Äî Connection Management</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:10px">
      <div>
        <div style="color:var(--green);font-weight:700;margin-bottom:6px">IMMER</div>
        <div style="color:var(--dim);line-height:1.7">
          ‚úì <code>forceWebsockets: true</code> ‚Äî kein HTTP-Polling Fallback<br>
          ‚úì Session-Filter bei jedem on("output")<br>
          ‚úì Connection im Pool nach connect() registrieren<br>
          ‚úì Auth-Fehler sofort als DEAD markieren
        </div>
      </div>
      <div>
        <div style="color:var(--red);font-weight:700;margin-bottom:6px">NIE</div>
        <div style="color:var(--dim);line-height:1.7">
          ‚úó Neue Connection pro Request erstellen<br>
          ‚úó SocketClient intern reconnecten lassen (<code>reconnection: false</code>)<br>
          ‚úó Ohne Session-Filter auf "output" h√∂ren<br>
          ‚úó Connection nach finalPing disconnecten
        </div>
      </div>
    </div>
  </div>

</div>


<!-- WEBCHAT UI PANEL -->
<div class="panel" id="webchat-ui">
<div class="flow">

  <div class="step">
    <div class="step-num-col"><div class="step-num sn-blue">1</div><div class="step-line sl-blue"></div></div>
    <div class="step-card">
      <div class="sc-header"><span class="tag" style="background:#0f1f35;color:var(--blue)">a2aClient.ts ó streamMessage()</span><span class="sc-title">SSE-Stream ˆffnen</span></div>
      <div class="sc-body">
        <div class="sc-detail">POST /agents/:id/ mit Accept: text/event-stream ? fetch() + ReadableStream Reader. JSON-RPC Envelope wird unwrapped: <code>envelope.result</code> ? A2A Event.</div>
        <div class="sc-code">fetch(agentUrl, { method:'POST', headers:{ Accept:'text/event-stream' } })</div>
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num" style="background:#0f2a1f;border-color:#1a4a30;color:var(--green)">2</div><div class="step-line" style="background:linear-gradient(var(--green),var(--cyan))"></div></div>
    <div class="step-card">
      <div class="sc-header"><span class="tag" style="background:#041a10;color:var(--green)">dispatchSseEvent()</span><span class="sc-title">Event-Typ erkennen &amp; dispatchen</span></div>
      <div class="sc-body">
        <div class="sc-detail">Drei Event-Typen werden verarbeitet:</div>
        <table class="norm-table" style="margin-top:8px">
          <tr><th>kind</th><th>Handler</th><th>Aktion</th></tr>
          <tr>
            <td><code>status-update</code></td>
            <td>state=working</td>
            <td>Liest <code>status.message.parts[]</code> ? <code>onPart(parts)</code> <span style="color:var(--green)">[FIX v3.6]</span></td>
          </tr>
          <tr>
            <td><code>artifact-update</code></td>
            <td>artifact.parts</td>
            <td><code>onPart(parts)</code></td>
          </tr>
          <tr>
            <td><code>message</code></td>
            <td>parts</td>
            <td><code>onPart(parts)</code></td>
          </tr>
        </table>
        <div class="sc-detail" style="margin-top:8px;color:var(--red)">Bug vor v3.6: status-update rief nur onWorking() ó message.parts wurden verworfen. Alle Socket-Inhalte blieben unsichtbar.</div>
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num" style="background:#0f1a2a;border-color:#1a3d4a;color:var(--cyan)">3</div><div class="step-line" style="background:linear-gradient(var(--cyan),var(--purple))"></div></div>
    <div class="step-card">
      <div class="sc-header"><span class="tag" style="background:#041520;color:var(--cyan)">useChat.ts ó appendParts()</span><span class="sc-title">Parts in ChatMessage mergen</span></div>
      <div class="sc-body">
        <div class="sc-detail">Jeder <code>onPart(parts)</code>-Call merged neue Parts in die laufende ChatMessage. TextParts werden zu <code>displayText</code> konkateniert. DataParts bleiben in <code>message.parts[]</code> f¸r zuk¸nftige Rich-UI-Renderer.</div>
        <div class="sc-code">merged = [...m.parts, ...newParts]
displayText = merged.filter(p =&gt; p.kind==='text').map(p =&gt; p.text).join('\n')</div>
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num" style="background:#1a0f2a;border-color:#3a1d5a;color:var(--purple)">4</div><div class="step-line" style="background:linear-gradient(var(--purple),var(--orange))"></div></div>
    <div class="step-card">
      <div class="sc-header"><span class="tag" style="background:#1a0c1f;color:var(--purple)">MessageBubble.tsx ó react-markdown</span><span class="sc-title">Markdown-Rendering</span></div>
      <div class="sc-body">
        <div class="sc-detail">Der <code>displayText</code> wird durch <code>react-markdown</code> gerendert. Custom components ¸berschreiben img, a, p und li:</div>
        <table class="norm-table" style="margin-top:8px">
          <tr><th>Markdown-Syntax</th><th>Gerendert als</th></tr>
          <tr><td><code>![image](url)</code></td><td>Inline-Bild, max 260px, lazy-loaded, rounded corners</td></tr>
          <tr><td><code>[text](url)</code></td><td>Klickbarer Link, target=_blank</td></tr>
          <tr><td><code>- Item</code></td><td>Bullet list, styled</td></tr>
          <tr><td><code>**bold**</code></td><td>Font-weight 600</td></tr>
          <tr><td><code>`code`</code></td><td>Inline code block</td></tr>
        </table>
        <div class="sc-detail" style="margin-top:8px">Typewriter-Animation (useTypewriter) l‰uft w‰hrend streaming ó react-markdown re-rendert pro Zeichen. Bild-Fallback: bei load-error wird URL als Text gezeigt.</div>
      </div>
    </div>
  </div>

  <div class="step">
    <div class="step-num-col"><div class="step-num" style="background:#1a0e00;border-color:#4a2800;color:var(--orange)">5</div></div>
    <div class="step-card">
      <div class="sc-header"><span class="tag" style="background:#1a0800;color:var(--orange)">Stream end</span><span class="sc-title">onDone() ? Status done</span></div>
      <div class="sc-body">
        <div class="sc-detail">Wenn der ReadableStream endet (final:true oder Connection closed) wird <code>onDone(contextId)</code> aufgerufen. Die ChatMessage wechselt von status:'streaming' zu status:'done'. Typewriter-Animation l‰uft noch bis zum letzten Zeichen durch.</div>
      </div>
    </div>
  </div>

</div>
</div>

<script>
function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('active','active-amber','active-cyan');
  });
  document.getElementById(id).classList.add('active');
  if (id === 'socket-mgmt') btn.classList.add('active-amber');
  else if (id === 'normalization') btn.classList.add('active-cyan');
  else btn.classList.add('active');
}
</script>
</body>
</html>
